<!DOCTYPE html>
<html lang="es"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/layoutRecepcionista}">

<head>
    <meta charset="UTF-8">
    <title>Registrar Cita Médica</title>

    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">

    <!-- Google Font -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Poppins', sans-serif;
            background: 
                linear-gradient(rgba(0,0,0,.4), rgba(0,0,0,.4)),
                url("https://images.unsplash.com/photo-1586773860418-d37222d8fce3?auto=format&fit=crop&w=1600&q=80");
            background-size: cover;
            background-position: center;
        }

        .dashboard-card {
            border-radius: 16px;
            transition: .3s;
        }

        .dashboard-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 15px 30px rgba(0,0,0,.2);
        }

        .card-header {
            background: linear-gradient(45deg,#0d6efd,#00b4d8);
            color: white;
            font-weight: 600;
        }

        .horario-btn {
            min-width: 90px;
            border-radius: 20px;
        }

        .horario-btn.active {
            background: #198754;
            color: white;
        }
    </style>
</head>

<body>
<section layout:fragment="content">

<div class="container py-5">

    <div class="card shadow-lg dashboard-card">
        <div class="card-header text-center">
            <h3><i class="bi bi-calendar2-plus"></i> Registrar Cita Médica</h3>
        </div>

        <div class="card-body bg-light">

            <form method="POST" th:action="@{/cita/registrar}">

                <div class="row g-4">

                    <!-- Paciente -->
                    <div class="col-md-6">
                        <div class="card dashboard-card h-100">
                            <div class="card-header">
                                <i class="bi bi-person"></i> Paciente
                            </div>
                            <div class="card-body">
                                <select name="idPaciente" class="form-select form-select-lg" required>
                                    <option value="" disabled selected>Seleccione paciente</option>
                                    <option th:each="p : ${listaPacientes}"
                                            th:value="${p.idPaciente}"
                                            th:text="${p.nombres} + ' ' + ${p.apellidos}">
                                    </option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Especialidad -->
                    <div class="col-md-6">
                        <div class="card dashboard-card h-100">
                            <div class="card-header">
                                <i class="bi bi-hospital"></i> Especialidad
                            </div>
                            <div class="card-body">
                                <select id="idEspecialidad" class="form-select form-select-lg" required>
                                    <option value="" disabled selected>Seleccione especialidad</option>
                                    <option th:each="e : ${listaEspecialidades}"
                                            th:value="${e.idEspecialidad}"
                                            th:text="${e.especialidad}">
                                    </option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Médico -->
                    <div class="col-md-6">
                        <div class="card dashboard-card h-100">
                            <div class="card-header">
                                <i class="bi bi-heart-pulse"></i> Médico
                            </div>
                            <div class="card-body">
                                <select name="idMedico" id="idMedico"
                                        class="form-select form-select-lg" required>
                                    <option value="" disabled selected>Seleccione médico</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Fecha -->
                    <div class="col-md-6">
                        <div class="card dashboard-card h-100">
                            <div class="card-header">
                                <i class="bi bi-calendar"></i> Fecha
                            </div>
                            <div class="card-body">
                                <input type="date" name="fechaCita" id="fechaCita"
                                       class="form-control form-control-lg" required>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Consultar -->
                <div class="text-center my-4">
                    <button type="button" id="btnConsultar"
                            class="btn btn-info btn-lg px-5">
                        <i class="bi bi-search"></i> Consultar Disponibilidad
                    </button>
                </div>

                <!-- Horarios -->
                <div class="card dashboard-card">
                    <div class="card-header">
                        <i class="bi bi-clock"></i> Horarios Disponibles
                    </div>
                    <div class="card-body">
                        <div id="bloques" class="d-flex flex-wrap gap-3"></div>
                        <input type="hidden" name="horaCita" id="horaCita">
                    </div>
                </div>

                <!-- Registrar -->
                <div class="text-center mt-4">
                    <button type="submit"
                            class="btn btn-success btn-lg px-5">
                        <i class="bi bi-check-circle"></i> Registrar Cita
                    </button>
                </div>

            </form>
        </div>
    </div>
	<hr class="my-5">
		<div class="card mb-4 border-0 shadow-sm">
		    <div class="card-body bg-light rounded">
		        <form th:action="@{/cita/registrar}" method="get" class="row g-3 align-items-end">
		            <div class="col-md-4">
		                <label class="form-label fw-bold small"><i class="bi bi-person-search"></i> Filtrar por Paciente</label>
		                <select name="fPaciente" class="form-select">
		                    <option value="">Todos los pacientes</option>
		                    <option th:each="p : ${listaPacientes}"
		                            th:value="${p.idPaciente}"
		                            th:text="${p.nombres} + ' ' + ${p.apellidos}">
		                    </option>
		                </select>
		            </div>
		            <div class="col-md-4">
		                <label class="form-label fw-bold small"><i class="bi bi-filter-circle"></i> Filtrar por Estado</label>
		                <select name="fEstado" class="form-select">
		                    <option value="">Todos los estados</option>
		                    <option th:each="est : ${estados}"
		                            th:value="${est}"
		                            th:text="${est}">
		                    </option>
		                </select>
		            </div>
		            <div class="col-md-4 d-flex gap-2">
		                <button type="submit" class="btn btn-primary flex-grow-1">
		                    <i class="bi bi-search"></i> Filtrar
		                </button>
		                <a th:href="@{/cita/registrar}" class="btn btn-secondary">
		                    <i class="bi bi-arrow-clockwise"></i> Limpiar
		                </a>
		            </div>
		        </form>
		    </div>
		</div>
		<h4 class="mb-4 text-center fw-bold" style="color: #0d6efd;">
		    <i class="bi bi-card-list"></i> Lista de Citas Médicas
		</h4>
		<div id="contenedorTabla">
			<div class="table-responsive shadow-sm rounded bg-white p-3">
					    <table class="table table-hover align-middle border text-center">
					        <thead class="table-success align-middle">
					            <tr>
					                <th>Nro</th>
					                <th>Paciente</th>
					                <th>Médico</th>
					                <th>Fecha</th>
					                <th>Hora</th>
					                <th>Estado</th>
					                <th>Acciones</th>
					            </tr>
					        </thead>
					        <tbody>
					            <tr th:each="c : ${listaCitas}">
					                <td class="fw-bold text-secondary" th:text="${c.nroCita}"></td>
					                <td th:text="${c.paciente.nombres}"></td>
					                <td th:text="${c.medico.nombres}"></td>
					                <td th:text="${#dates.format(c.fechaCita, 'dd/MM/yyyy')}"></td>
					                <td th:text="${c.horaCita}"></td>
					                <td>
				                        <span class="badge rounded-pill px-3 py-2" 
					                          th:classappend="${c.estado.name() == 'pagado' ? 'bg-success' : 
					                                         (c.estado.name() == 'cancelado' ? 'bg-danger' : 'bg-warning text-dark')}"
					                          th:text="${c.estado}">
					                    </span>
					                </td>
					                <td>
					                    <div class="d-flex justify-content-center gap-2 align-items-center">
					                        
				                            <form th:action="@{/cita/cambiar-estado}" method="post" class="d-flex m-0">
					                            <input type="hidden" name="nroCita" th:value="${c.nroCita}" />
					                            
				                                <select name="nuevoEstado" class="form-select form-select-sm border-secondary me-1" style="width: 140px;" required 
					                                    th:disabled="${c.estado.name() == 'pagado'}">
					                                <option value="" disabled selected>Cambiar a...</option>
					                                <option value="pendiente_pago" th:if="${c.estado.name() != 'pendiente_pago'}">Pendiente</option>
					                                <option value="cancelado" th:if="${c.estado.name() != 'cancelado'}">Cancelar</option>
					                            </select>
					                            
					                            <button type="submit" class="btn btn-sm btn-primary" title="Guardar Estado" th:disabled="${c.estado.name() == 'pagado'}">
					                                <i class="bi bi-check2-circle"></i>
					                            </button>
					                        </form>

					                        <a th:href="@{'/cita/generar-pdf/' + ${c.nroCita}}" 
					                           target="_blank" 
					                           class="btn btn-sm btn-outline-danger d-flex align-items-center"
				                               title="Descargar Ticket">
					                            <i class="bi bi-filetype-pdf me-1"></i> PDF
					                        </a>
					                    </div>
					                </td>
					            </tr>
					        </tbody>
					    </table>
					</div>
		</div>
</section>
<div layout:fragment="scripts">
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script th:src="@{/js/registrar-cita.js}"></script>
</div>
</body>
</html>
